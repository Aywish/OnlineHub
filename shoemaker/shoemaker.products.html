<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title class="customer-name">Made in Marikina - Products</title>

        <!-- icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.0/font/bootstrap-icons.css">

         <!-- bootstrap and css -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/ShoemakerAccess.css">

        <!-- jQuery and js-->
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script type="text/javascript">
            //popups
            function AddPopup() {
                document.getElementById("add_product").style.display = "block";
                document.getElementById("bgoverlay").style.display = "block";
            }

            function ClosePopup() {
                document.getElementById("add_product").style.display = "none";
                document.getElementById("edit_product").style.display = "none";
                document.getElementById("bgoverlay").style.display = "none";
            }

            //colorpicker
            function colorInputCaller() {
                let colorInput = document.querySelector("#color");
                let hexInput = document.querySelector("#hex");
                colorInput.addEventListener('input',()=>{
                    let color = colorInput.value;
                    hexInput.value = color;
                    document.querySelector('i').style.color = color;
                });
            }

        </script>

        <!--jquery-->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script>
            //to add colors on shoe products
        $(document).ready(function(){
            var i=0, x=0;
            $("#add_color").click(function(){
                $('#colortd'+i).html("<input type='color' id='color' name='shoe-color' id='color"+(i+1)+"'></input>");
                
                $('#color_row').append('<td id="colortd'+(i+1)+'"></td>');
                i++;
                });

            //to add sizes on shoe products
            $("#add_shoesize").click(function(){
                $('#tab_size').append('<td id="sizetd'+x+'""><input type="text" name="shoe-size" id="size'+x+'" placeholder="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))"></input></td>');
                x++;
            });
        });
        </script>
    </head>
    <body>
        <div class="bgoverlay" id="bgoverlay">
        </div>
        <div class="top-level">
            <div class="top-title">
                <h1>Products</h1>
            </div>
            <div class="top-buttons">
                <label for="add" class="buttonss banner-add" onclick="AddPopup()">
                        <i class="bi bi-plus-circle"></i>
                        <span>ADD</span>
                </label>
            </div>
        </div>
        <div class="table">
            <table id="product-View">
                <tr>
                    <th><h4 class="tblHeader">IMAGE</h4></th>
                    <th><h4 class="tblHeader">PRODUCT NAME</h4></th>
                    <th><h4 class="tblHeader">PRICE</h4></th>
                    <th><h4 class="tblHeader">ACTIONS</h4></th>
                </tr>
                    <!-- CONTENT IS GENERATED FROM THE DATABASE -->
            </table>
        </div>
        <!--POPUP-->
        <!-- FOR EDITING A PRODUCT -->
        <div class="popup" id="edit_product">
            <div class="popup-scrollable">
                <i class="bi bi-x" onclick="ClosePopup()"></i>
                <div class="popup-content">
                    <div class="popup-section product-left">
                        <div class="product-left product-img">
                            <div class="product-img big-img">
                                <div id="display_image_edit">
                                    <input type="file" id="image_input_edit">
                                    <label for="image_input_edit" class="add-image">
                                        <i class="bi bi-plus-circle-dotted"></i>
                                    </label>
                                    <span>Add Image</span>
                                </div>
                            </div>
                        </div>
                        <div class="product-left upload-progress">
                            <h4>Upload Progress</h4>
                            <label class="uploadProgress" id="upProgressEdit"></label>
                        </div>
                        <div class="product-left product-colorsize">
                            <table>
                                <tr id="tab_logic">
                                    <td><i class="bi bi-plus-circle-dotted" id="add_colors"></i></td>
                                    <td id="addr0"><input type="color" name="shoe-color" id="color0"></input></td>
                                    <td id="addr1"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="product-left product-colorsize">
                            <table>
                                <tr id="tab_sizes">
                                    <td><i class="bi bi-plus-square-dotted" id="add_sizes" ></i></td>
                                    <td id="sizetd0"><input type="text" name="shoe-size" id="size0" placeholder="0"></td>
                                    <td id="sizetd1"></td>
                                </tr>
                            </table>      
                        </div>
                    </div>
        
                    <div class="popup-section product-right">
                        <input type="text" class="fields" placeholder="Shoe Name" id="shoename">
                        <br>
                        <input type="text"  class="fields"  placeholder="Price" id="shoeprice">
                        <br>
                        <div class="description">
                            <input type="textarea"  class="fields-desc"  placeholder="Description" id="shoedesc">
                        </div>
                    </div>
                </div>
            </div>
            <div class="addtocart">
                <a href="#" id="saveEdit">SAVE</a>
            </div>
        </div>
        <!-- FOR ADDING A PRODUCT -->
        <div class="popup" id="add_product">
            <div class="popup-scrollable">
                <i class="bi bi-x" onclick="ClosePopup()"></i>
                <div class="popup-content">
                    <div class="popup-section product-left">
                        <div class="product-left product-img">                    
                            <div  class="product-img big-img">
                                <div id="display_image_add">
                                    <input type="file" id="image_input_add">
                                    <label for="image_input_add" class="add-image">
                                        <i class="bi bi-plus-circle-dotted"></i>
                                    </label>
                                    <span>Add Image</span>
                                </div>
                            </div>
                        </div>
                        <div class="product-left upload-progress">
                            <h4>Upload Progress</h4>
                            <label class="uploadProgress" id="upProgressAdd"></label>
                        </div>
                        <div class="product-left product-colorsize">
                            <table>
                                <tr id="color_row">
                                    <td><i class="bi bi-plus-circle-dotted" id="add_color"></i></td>
                                    <td id="colortd0"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="product-left product-colorsize">
                            <table>
                                <tr id="tab_size">
                                    <td><i class="bi bi-plus-square-dotted" id="add_shoesize" ></i></td>
                                </tr>
                            </table>   
                        </div>
                    </div>
        
                    <div class="popup-section product-right" style="margin-top: 50px;">
                        <input type="text" class="fields" placeholder="Shoe Name" id="addProd_ShoeName">
                        <br>
                        <input type="text"  class="fields"  placeholder="Price" id="addProd_ShoePrice" required>
                        <br>
                        <select name="categories" id="addProd_ShoeCategory"  class="fields">
                            <option value="" disabled selected>Category</option>
                            <option value="lacedup">Laced Up</option>
                            <option value="sneakers">Sneakers</option>
                            <option value="Sandals">Sandals</option>
                            <option value="menshoes">Men Shoes</option>
                            <option value="flatsandals">Flat Sandals</option>
                            <option value="indoorslippers">Indoor Slippers</option>
                          </select>

                        <br>
                        <div class="description">
                            <input type="textarea"  class="fields-desc"  placeholder="Description" id="addProd_ShoeDescription">
                        </div>
                    </div>
                </div>
            </div>
            <div class="addtocart">
                
                <a href="#" id="addtocart"><button id="btnAddProduct">Add Product</button></a>
            </div>
        </div>
        <!--END OF POPUP-->

        <script>
            var shmkrId = localStorage.getItem("userID");

            var shmkrName, userType, username, editprodId;

            var today = new Date();
            var time = new Date().getFullYear() + "" + new Date().getMonth()  + 1 + "" + new Date().getDate()  + "" + today.getHours() + "" + today.getMinutes() + "" + today.getSeconds();

            var shoeName, shoePrice, shoeDescription;
            var prodID_var = time;


            function readAddForm() {
                shoeName = document.getElementById("addProd_ShoeName").value;
                shoePrice = document.getElementById("addProd_ShoePrice").value;
                shoeCategory = document.getElementById("addProd_ShoeCategory").value;
                shoeDescription = document.getElementById("addProd_ShoeDescription").value;
            }

            // LOAD IMAGE
            const image_input_add = document.querySelector("#image_input_add");
            var uploaded_image;

            image_input_add.addEventListener('change', function() {
                const reader = new FileReader();
                reader.addEventListener('load', () => {
                    uploaded_image = reader.result;
                    document.querySelector("#display_image_add").style.backgroundImage = `url(${uploaded_image})`;
                });
                reader.readAsDataURL(this.files[0]);
            });

            
            const image_input_edit = document.querySelector("#image_input_edit");
            var uploaded_image;

            image_input_edit.addEventListener('change', function() {
                const reader = new FileReader();
                reader.addEventListener('load', () => {
                    uploaded_image = reader.result;
                    document.querySelector("#display_image_edit").style.backgroundImage = `url(${uploaded_image})`;
                });
                reader.readAsDataURL(this.files[0]);
            });


            //Create

            const saveProduct = document.querySelector("#btnAddProduct");
            saveProduct.addEventListener('click', function(e) {
                readAddForm();
                colorInputCaller();
                e.preventDefault();

                const storage = firebase.storage();
                const storageRef = storage.ref();

                var file = image_input_add.files[0];
                var name = prodID_var;
                var imgId = prodID_var;
                var metadata = {
                    contentType: file.type
                }

                var uploadTask = storageRef.child(shmkrId + "/shoemakerProducts/" + prodID_var).put(file, metadata);

                uploadTask.on('state_changed', function(snapshot){
                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById("upProgressAdd").innerHTML = 'Upload ' + progress + ' %';
                })

                uploadTask.then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    imgUrl = url;

                    firebase
                    .database()
                    .ref("products/" + prodID_var.toString())
                    .set({
                        shoeMakerID: shmkrId,
                        prodId: prodID_var,
                        prodName: shoeName,
                        prodPrice: parseFloat(shoePrice),
                        prodCategory: shoeCategory,
                        prodDesc: shoeDescription,
                        imageID: imgId,
                        imageName: name,
                        imageLink: imgUrl
                    });
                    alert("Product Added!");
                    ClosePopup();
                });
                
            });

            firebase.database()
                .ref("users/" + shmkrId)
                .on("value", function (snap) {
                userType = snap.val().accountType;
                username = snap.val().name;
                });
                
            
            var prodReference = firebase.database().ref().child("products/").orderByChild('shoeMakerID').equalTo(shmkrId);
            prodReference.on("child_added", snap => {
                var cProdId = snap.child("prodId").val();
                var cProdName = snap.child("prodName").val();
                var cProdPrice = snap.child("prodPrice").val();
                var cImageLink = snap.child("imageLink").val();


                $("#product-View").append('<tr><td><img class="tblImage" src=" ' + cImageLink + ' "></td><td><p>' + cProdName + '<p></td><td><p>' + cProdPrice + '</p></td><td><button class="button-actions" onclick="EditPopup(' + cProdId + ')"><i class="bi bi-pencil"></i><span>EDIT</span></button><button class="button-actions" onclick="deleteProd(' + cProdId + ')"><i class="bi bi-trash"></i><span>DELETE</span></button></td></tr>');

            });


            // READ THE DATA IN THE EDIT POPUP
            function readCrudForm() {
                name_var = document.getElementById("shoename").value;
                price_var = document.getElementById("shoeprice").value;
                desc_var = document.getElementById("shoedesc").value;
            };
            

            // PASS VALUES OF THE CHOSEN PRODUCT TO THE EDIT POPUP
            function EditPopup(id) {
                editprodId = id;

                firebase.database()
                    .ref("products/" + id)
                    .on("value", function (snap) {
                    vwProdName = snap.val().prodName;
                    vwProdPrice = snap.val().prodPrice;
                    vwProdDesc = snap.val().prodDesc;
                    
                    //alert(user);
                        document.getElementById("shoename").value = vwProdName;
                        document.getElementById("shoeprice").value = vwProdPrice;
                        document.getElementById("shoedesc").value = vwProdDesc;

                    });
                

                document.getElementById("edit_product").style.display = "block";
                document.getElementById("bgoverlay").style.display = "block";

            }


            // UPDATE THE DATA IN THE DATABASE
            const saveEdit = document.querySelector("#saveEdit");
            saveEdit.addEventListener('click', function(e) {
                readCrudForm();
                // colorInputCaller();
                e.preventDefault();

                const storage = firebase.storage();
                const storageRef = storage.ref();

                var file = image_input_edit.files[0];
                var name = prodID_var;
                var imgId = prodID_var;
                var metadata = {
                    contentType: file.type
                }

                var uploadTask = storageRef.child(shmkrId + "/shoemakerProducts/" + prodID_var).put(file, metadata);

                uploadTask.on('state_changed', function(snapshot){
                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById("upProgressEdit").innerHTML = 'Upload ' + progress + ' %';
                })

                uploadTask.then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    imgUrl = url;

                
                firebase
                    .database()
                    .ref("products/" + editprodId)
                    .update({
                    //   prodId: rollV,
                    prodName: name_var,
                    prodPrice: parseFloat(price_var),
                    prodDesc: desc_var,
                    imageID: imgId,
                    imageName: name,
                    imageLink: imgUrl
                    });
                alert("Product Updated");
                location.reload();
                });
            });


            // DELETE PRODUCT IN THE DATABASE
            function deleteProd(id) {
                editprodId = id;
                readCrudForm();
                
                warning = "Delete this product?";

                if (confirm(warning) == true) {
                    firebase
                        .database()
                        .ref("products/" + editprodId)
                        .remove();
                    alert("Product Deleted");
                    location.reload();
                } else {
                    alert("You cancelled!");
                }
            
            };

        </script>
</body>

</html>